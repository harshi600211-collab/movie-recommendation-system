import pandas as pd
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import linear_kernel

# 1. DATA PREPARATION & VECTORIZATION

# Assuming 'movies_df' is your DataFrame loaded from a dataset 
# (e.g., tmdb_5000_movies.csv) with a 'title' and 'overview' column.
# Replace NaN in 'overview' with an empty string for safety
movies_df['overview'] = movies_df['overview'].fillna('')

# Initialize the TFIDF Vectorizer:
# TF-IDF (Term Frequency-Inverse Document Frequency) measures how important a word 
# is to a document in a corpus. We remove common English words (stop_words).
tfidf = TfidfVectorizer(stop_words='english')

# Construct the TF-IDF matrix (learns the vocabulary and transforms the data)
tfidf_matrix = tfidf.fit_transform(movies_df['overview'])

# 2. COSINE SIMILARITY CALCULATION

# Compute the cosine similarity matrix. 
# Cosine Similarity is a measure of similarity between two non-zero vectors 
# of an inner product space, often used to measure document similarity.
# linear_kernel is an optimized version of cosine similarity for sparse matrices.
cosine_sim = linear_kernel(tfidf_matrix, tfidf_matrix)

# 3. RECOMMENDATION FUNCTION

# Construct a reverse map of movie titles and their corresponding DataFrame indices
indices = pd.Series(movies_df.index, index=movies_df['title']).drop_duplicates()

def get_recommendations(title, cosine_sim=cosine_sim):
    """
    Generates a list of the 10 most similar movies to a given movie title.
    """
    # Get the index of the movie that matches the title
    try:
        idx = indices[title]
    except KeyError:
        return f"Movie '{title}' not found in the dataset."

    # Get the pairwise similarity scores of all movies with that movie
    sim_scores = list(enumerate(cosine_sim[idx]))

    # Sort the movies based on the similarity scores in descending order
    sim_scores = sorted(sim_scores, key=lambda x: x[1], reverse=True)

    # Get the scores of the 10 most similar movies (excluding the movie itself, which is always 100% similar)
    sim_scores = sim_scores[1:11]

    # Get the movie indices
    movie_indices = [i[0] for i in sim_scores]

    # Return the top 10 most similar movie titles
    return movies_df['title'].iloc[movie_indices]

# 4. TESTING
# Example call (assuming the movie exists in your dataset):
# print(get_recommendations('The Dark Knight Rises'))
